# 回测

使用NautilusTrader进行回测是一个有条理的模拟过程，使用特定系统实现复制交易活动。该系统由各种组件组成，包括内置引擎、`Cache`、[消息总线](message_bus_CN.md)、`Portfolio`、[角色](actors_CN.md)、[策略](strategies_CN.md)、[执行算法](execution_CN.md)和其他用户定义的模块。整个交易模拟基于由`BacktestEngine`处理的历史数据流。一旦这个数据流耗尽，引擎结束其操作，产生详细的结果和性能指标以进行深入分析。

重要的是要认识到NautilusTrader为设置和进行回测提供了两个不同的API级别：

- **高级API**：使用`BacktestNode`和配置对象（内部使用`BacktestEngine`）。
- **低级API**：直接使用`BacktestEngine`进行更"手动"的设置。

## 选择API级别

在以下情况下考虑使用**低级**API：

- 您的整个数据流可以在可用的机器资源（例如，RAM）内处理。
- 您不希望将数据存储为Nautilus特定的Parquet格式。
- 您有特定需求或偏好保留原始格式的原始数据（例如，CSV、二进制等）。
- 您需要对`BacktestEngine`进行细粒度控制，例如能够在相同数据集上重新运行回测，同时交换组件（例如，角色或策略）或调整参数配置。

在以下情况下考虑使用**高级**API：

- 您的数据流超过可用内存，需要分批流式传输数据。
- 您希望利用`ParquetDataCatalog`的性能和便利性，将数据存储为Nautilus特定的Parquet格式。
- 您重视传递配置对象的灵活性和功能，以定义和管理跨多个引擎同时进行的多个回测运行。

## 低级API

低级API围绕`BacktestEngine`，其中输入通过Python脚本手动初始化和添加。
实例化的`BacktestEngine`可以接受以下内容：

- `Data`对象列表，基于`ts_init`自动排序为单调顺序。
- 多个场所，手动初始化。
- 多个角色，手动初始化和添加。
- 多个执行算法，手动初始化和添加。

这种方法提供了对回测过程的详细控制，允许您手动配置每个组件。

## 高级API

高级API围绕`BacktestNode`，它协调多个`BacktestEngine`实例的管理，每个实例由`BacktestRunConfig`定义。多个配置可以捆绑到列表中，并由节点在一次运行中处理。

每个`BacktestRunConfig`对象包括以下内容：

- `BacktestDataConfig`对象列表。
- `BacktestVenueConfig`对象列表。
- `ImportableActorConfig`对象列表。
- `ImportableStrategyConfig`对象列表。
- `ImportableExecAlgorithmConfig`对象列表。
- 可选的`ImportableControllerConfig`对象。
- 可选的`BacktestEngineConfig`对象，如果未指定则使用默认配置。

## 数据

为回测提供的数据驱动执行流程。由于可以使用各种数据类型，确保您的场所配置与为回测提供的数据保持一致至关重要。数据和配置之间的不匹配可能导致执行期间的意外行为。

NautilusTrader主要设计和优化用于订单簿数据，它提供市场中每个价格级别或订单的完整表示，反映交易场所的实时行为。这确保了最高级别的执行粒度和真实性。但是，如果粒度订单簿数据不可用或不必要，平台有能力按以下详细程度的降序处理市场数据：

1. **订单簿数据/增量（L3市场按订单）**：
   - 提供全面的市场深度和详细的订单流，可见所有单个订单。

2. **订单簿数据/增量（L2市场按价格）**：
   - 提供跨所有价格级别的市场深度可见性。

3. **报价Tick（L1市场按价格）**：
   - 代表"账簿顶部"，仅捕获最佳买价和卖价及大小。

4. **交易Tick**：
   - 反映实际执行的交易，提供交易活动的精确视图。

5. **K线**：
   - 聚合交易活动 - 通常在固定时间间隔内，如1分钟、1小时或1天。

### 选择数据：成本vs准确性

对于许多交易策略，K线数据（例如，1分钟）对于回测和策略开发来说是足够的。这一点特别重要，因为与tick或订单簿数据相比，K线数据通常更容易获得且成本效益更高。

考虑到这种实际情况，Nautilus被设计为支持基于K线的回测，具有高级功能，即使在使用较低粒度数据时也能最大化模拟准确性。

:::tip
对于某些交易策略，从K线数据开始开发以验证核心交易想法是实用的。如果策略看起来有前景，但对精确执行时机更敏感（例如，需要在OHLC级别之间的特定价格成交，或使用紧密的止盈/止损级别），您可以投资更高粒度的数据以获得更准确的验证。
:::

## 场所

在为回测初始化场所时，您必须从以下选项中为执行处理指定其内部订单`book_type`： 