# 编码标准

## 代码风格

当前代码库可以作为格式化约定的指南。
下面提供了其他指导原则。

### 通用格式化规则

以下适用于**所有**源文件（Rust、Python、Cython、shell等）：

- **仅使用空格**，永远不要使用硬制表符。
- 行通常应保持在**100个字符**以下；在必要时请谨慎换行。
- 偏好美式英语拼写（`color`、`serialize`、`behavior`）。

### 注释约定

1. 通常在每个注释块或文档字符串**上方留一空行**，使其在视觉上与代码分离。
2. 使用*句子大小写* - 首字母大写，其余保持小写，除非是专有名词或缩写词。
3. 句号后不要使用双空格。
4. **单行注释***不得*以句号结尾，*除非*行以URL或内联Markdown链接结尾 - 在这些情况下，保留链接所需的确切标点符号。
5. **多行注释**应使用逗号分隔句子（不是每行一个句号）。最后一行*应该*以句号结尾。
6. 保持注释简洁；偏好清晰，只解释不明显的内容 - *少即是多*。
7. 避免在文本中使用表情符号。

### 文档注释/文档字符串语气

- **Python**文档字符串应使用**祈使语气**编写 - 例如*"Return a cached client."*
- **Rust**文档注释应使用**陈述语气**编写 - 例如*"Returns a cached client."*

这些约定与每种语言生态系统的主流风格保持一致，使生成的文档对最终用户感觉自然。

### 格式化

1. 对于较长的代码行，以及传递多个参数时，您应该换行并在下一个逻辑缩进处对齐（而不是尝试从开括号进行悬挂的"虚荣"对齐）。这种做法节省右侧空间，确保重要代码在视图中更居中，并且对函数/方法名称更改也很稳健。

2. 右括号应位于新行上，在逻辑缩进处对齐。

3. 还要确保多个悬挂参数或论据以尾随逗号结尾：

```python
long_method_with_many_params(
    some_arg1,
    some_arg2,
    some_arg3,  # <-- 尾随逗号
)
```

### PEP-8

代码库通常遵循PEP-8风格指南。尽管在代码库的Cython部分利用了C类型，我们仍然尽可能地保持Python的惯用性。
一个值得注意的偏离是，Python的真值性并不总是用于检查除集合之外的所有参数是否为`None`。

有两个原因：

1. Cython可以从`is None`和`is not None`生成更高效的C代码，而不是进入Python运行时检查`PyObject`的真值性。

2. 根据[Google Python风格指南](https://google.github.io/styleguide/pyguide.html) - 不鼓励使用真值性来检查参数是/不是`None`，当有机会将意外对象传递到函数或方法中时，这会产生意外的真值性评估（可能导致逻辑错误类型的bug）。

*"总是使用if foo is None:（或is not None）来检查None值。例如，当测试默认为None的变量或参数是否设置为其他值时。其他值可能是在布尔上下文中为false的值！"*

在不是性能关键的区域，为了清晰起见，对`None`的真值性检查（`if foo is None:` vs `if not foo:`）仍然是可接受的。

:::note
使用真值性检查空集合（例如，`if not my_list:`），而不是明确与`None`或空进行比较。
:::

我们欢迎关于代码库在何处无明显原因偏离PEP-8的所有反馈。

## Python风格指南

### 类型提示

所有函数和方法签名*必须*包含全面的类型注释：

```python
def __init__(self, config: EMACrossConfig) -> None:
def on_bar(self, bar: Bar) -> None:
def on_save(self) -> dict[str, bytes]:
``` 